{"version":3,"sources":["db-test.js"],"names":["test","require","uuid","r","Db","utils","fixtures","beforeEach","t","dbName","v4","db","connect","context","true","connected","afterEach","always","disconnect","false","conn","dbDrop","run","is","guardarImagen","imagen","getImage","created","description","url","likes","liked","deepEqual","tags","userId","id","publicId","encode","truthy","createdAt","likeImagen","result","getImagen","throws","imagenes","getImages","guardarImagenes","map","img","Promise","all","getImagenes","length","guardarUsuario","usuario","getUser","referenciaPassword","password","username","email","name","encryptar","getUsuario","autenticar","exitoso","fallido","falla","getImagenesPorUsuario","random","Math","round","i","push"],"mappings":"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","file":"db-test.js","sourcesContent":["'use strict'\r\n\r\nconst test = require('ava')\r\nconst uuid = require('uuid-base62')\r\nconst r = require('rethinkdb')\r\nconst Db = require('../')\r\nconst utils = require('../lib/utils')\r\nconst fixtures = require('./fixtures')\r\n\r\ntest.beforeEach('configurar base de datos', async t => {\r\n  const dbName = `senagram_${uuid.v4()}`\r\n  const db = new Db({db: dbName})\r\n  await db.connect()\r\n  t.context.db = db\r\n  t.context.dbName = dbName\r\n  t.true(db.connected, 'esta conectado')\r\n})\r\n\r\ntest.afterEach.always('desconectando y limpiando base de datos', async t => {\r\n  let db = t.context.db\r\n  let dbName = t.context.dbName\r\n\r\n  await db.disconnect()\r\n  t.false(db.connected, 'esta desconectado')\r\n\r\n  let conn = await r.connect({})\r\n  await r.dbDrop(dbName).run(conn)\r\n})\r\n\r\ntest('guardar imagen', async t => {\r\n  let db = t.context.db\r\n  t.is(typeof db.guardarImagen, 'function', 'guardarImagen es una funcion')\r\n\r\n  let imagen = fixtures.getImage()\r\n\r\n  let created = await db.guardarImagen(imagen)\r\n  t.is(created.description, imagen.description)\r\n  t.is(created.url, imagen.url)\r\n  t.is(created.likes, imagen.likes)\r\n  t.is(created.liked, imagen.liked)\r\n  t.deepEqual(created.tags, ['genial', 'tags', 'senagram'])\r\n  t.is(created.userId, imagen.userId)\r\n  t.is(typeof created.id, 'string')\r\n  t.is(created.publicId, uuid.encode(created.id))\r\n  t.truthy(created.createdAt)\r\n})\r\n\r\ntest('like imagenes', async t => {\r\n  let db = t.context.db\r\n  t.is(typeof db.likeImagen, 'function', 'likeImagen es una funcion ')\r\n\r\n  let imagen = fixtures.getImage()\r\n  let created = await db.guardarImagen(imagen)\r\n  let result = await db.likeImagen(created.publicId)\r\n  t.true(result.liked)\r\n  t.is(result.likes, imagen.likes + 1)\r\n})\r\n\r\ntest('obtener imagen', async t => {\r\n  let db = t.context.db\r\n  t.is(typeof db.getImagen, 'function', 'getImage es una funcion')\r\n\r\n  let imagen = fixtures.getImage()\r\n  let created = await db.guardarImagen(imagen)\r\n  let result = await db.getImagen(created.publicId)\r\n\r\n  t.deepEqual(created, result)\r\n\r\n  await t.throws(db.getImagen('equivoca'), /no encontrado/)\r\n})\r\n\r\ntest('listar todas las imagenes', async t => {\r\n  let db = t.context.db\r\n  let imagenes = await fixtures.getImages()\r\n  let guardarImagenes = imagenes.map(img => db.guardarImagen(img))\r\n  let created = await Promise.all(guardarImagenes)\r\n  let result = await db.getImagenes()\r\n\r\n  t.is(created.length, result.length)\r\n})\r\n\r\ntest('guardar usarios', async t => {\r\n  let db = t.context.db\r\n\r\n  t.is(typeof db.guardarUsuario, 'function', 'guardarUsuario es una funcion')\r\n\r\n  let usuario = fixtures.getUser()\r\n  let referenciaPassword = usuario.password\r\n  let created = await db.guardarUsuario(usuario)\r\n\r\n  t.is(usuario.username, created.username)\r\n  t.is(usuario.email, created.email)\r\n  t.is(usuario.name, created.name)\r\n  t.is(utils.encryptar(referenciaPassword), created.password)\r\n  t.is(typeof created.id, 'string')\r\n  t.truthy(created.createdAt)\r\n})\r\n\r\ntest('obtener usuario', async t => {\r\n  let db = t.context.db\r\n\r\n  t.is(typeof db.getUsuario, 'function', 'obtener usuario')\r\n\r\n  let usuario = fixtures.getUser()\r\n  let created = await db.guardarUsuario(usuario)\r\n  let result = await db.getUsuario(usuario.username)\r\n\r\n  t.deepEqual(created, result)\r\n\r\n  await t.throws(db.getUsuario('jaa'), /no encontrado/)\r\n})\r\n\r\ntest('autenticar usuario', async t => {\r\n  let db = t.context.db\r\n\r\n  t.is(typeof db.autenticar, 'function', 'autenticar es una funicion')\r\n\r\n  let usuario = fixtures.getUser()\r\n  let referenciaPassword = usuario.password\r\n  await db.guardarUsuario(usuario)\r\n\r\n  let exitoso = await db.autenticar(usuario.username, referenciaPassword)\r\n  t.true(exitoso)\r\n\r\n  let fallido = await db.autenticar(usuario.username, 'jaa')\r\n  t.false(fallido)\r\n\r\n  let falla = await db.autenticar('jaa', 'bar')\r\n  t.false(falla)\r\n})\r\n\r\ntest('listar fotos por usuario', async t => {\r\n  let db = t.context.db\r\n\r\n  t.is(typeof db.getImagenesPorUsuario, 'function', 'getImagenesPorUsuario es una funcion')\r\n\r\n  let imagenes = fixtures.getImages(10)\r\n  let userId = uuid.uuid()\r\n  let random = Math.round(Math.random() * imagenes.length)\r\n\r\n  let guardarImagenes = []\r\n  for (let i = 0; i < imagenes.length; i++) {\r\n    if (i < random) {\r\n      imagenes[i].userId = userId\r\n    }\r\n\r\n    guardarImagenes.push(db.guardarImagenes(imagenes[i]))\r\n  }\r\n\r\n  await Promise.all(guardarImagenes)\r\n\r\n  let result = await db.getImagenesPorUsuario(userId)\r\n  t.is(result.length, random)\r\n})\r\n"]}